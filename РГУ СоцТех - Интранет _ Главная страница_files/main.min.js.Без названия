function closeW() {
    $('#msg_attach_area').hide();
    $('#sm').hide();
    $('#stat').html('');
    $('body').css('overflow', '');
}

function openMForm(uval, puid) {
    showHide('sm');
    $('body').css('overflow', 'hidden');
    $('#mes_val').focus();
    createNewDialog(uval, puid);

}

function showHide(elem) {
    var obj = document.getElementById(elem);
    if ($(obj).css('display') == 'block') {
        $(obj).hide(300);
    } else {
        $(obj).show();
    }
}

var custom_scroll_instances = [];

function initCustomScroll() {
	
    if (typeof baron == 'undefined') return false;
	
    if (custom_scroll_instances.length) {
        custom_scroll_instances.dispose();
    }
	
    custom_scroll_instances = baron({
        root: '.baron',
        scroller: '.baron__scroller',
        bar: '.baron__bar',
        scrollingCls: '_scrolling',
        draggingCls: '_dragging'
    }).controls({
        track: '.baron__track',
        forward: '.baron__down',
        backward: '.baron__up'
    });

}

var events_history_offset = 0,
    events_history_offset_delta = 0,
    events_history_limit = 15,
    events_history_load_next = true,
    events_history_load_scroll = true;

function getUserEventsHistory(ct) {

    ct = ct || null;
    if (ct) ct = $(ct);

    var aObj = $('#user_events_notificaton_history_wraper'),
        nc = $('#user_events_notificaton_history_content_loaded_data');

    if (
        (
            ct &&
            ct.closest('#user_events_notificaton_history_wraper').length
        ) ||
        (
            ct &&
            ct.closest('.user_event_history_item').length
        )
    ) {
        return false;
    }


    if (!ct || !aObj.css('display') || aObj.css('display') == 'none') {

        if (!events_history_load_next) return false;

        events_history_load_next = false;
        events_history_load_scroll = true;
		
        if (events_history_offset == 0) {
            events_history_offset_delta = 0;
        }

        var events_history_html = '',
            ih = 0,
            event_items_show_count = 0;

        aObj.fadeIn();
        $('.user_event_history_loading_error').remove();
        $(nc).append('<div id="user_events_history_preloader" class="col-md-12 text-center"><img style="width:40px;" src="/files/upload/pages/image/32.gif" alt="Загрузка..." title=""/></div>');

        $.post('/user_events_notificaton_history_content_load', {
            'nc': 1,
            'offset': events_history_offset + events_history_offset_delta,
            'limit': events_history_limit
        }, function(data) {
            if (data.length) {

                $.each(data, function() {

                    var act_ico = 'briefcase',
                        act_ico_color = '#dda53a',
                        act_href = data[ih]['type'] < 3 ? '/posts?action=show&postid=' + data[ih]['oid'] : '/eds/eds_tasks?section=eds_show_task&task_id=' + data[ih]['oid'],
                        act_mark_js = 'onclick="$(this).parents(\'.user_event_history_item\').removeClass(\'not-shown\')"',
                        act_text = data[ih]['ptitle'] + '. <a ' + act_mark_js + ' target="_blank" href="' + act_href + '">К задаче</a>',
                        event_item_shown = '';

                    if (data[ih]['type'] == 1) {
                        act_ico = 'comment';
                        act_ico_color = 'inherit';
                        act_text = 'Новый комментарий к записи <a ' + act_mark_js + ' target="_blank" href="' + act_href + '">' + data[ih]['ptitle'] + '</a>';
                    }

                    if (data[ih]['type'] == 2) {
                        act_ico = 'heart';
                        act_ico_color = 'red';
                        act_text = 'Оценка записи <a ' + act_mark_js + ' target="_blank" href="' + act_href + '">' + data[ih]['ptitle'] + '</a>';
                    }
					
                    if (data[ih]['type'] == 4) {
                        act_ico = 'check';
                        act_ico_color = '#a556b9';
                        act_href = data[ih]['curr_user_type'] == 2 ? '/studentplan' : '/accrual_of_points?q=' + data[ih]['fio'];
                        act_text = data[ih]['ptitle'] + '. <a ' + act_mark_js + ' target="_blank" href="' + act_href + '">Распределить баллы</a>';
                    }

                    if (!data[ih]['shown']) {
                        event_item_shown = ' not-shown';
                        event_items_show_count++;
                    }

                    events_history_html += '<div data-act-param="h-event-item-' + data[ih]['type'] + '-' + data[ih]['userid'] + '-' + data[ih]['oid'] + '" class="user_event_history_item' + event_item_shown + '">';
                    events_history_html += '<div class="col-md-2 col-sm-2 col-xs-2 text-center">';
                    events_history_html += '<div class="users_avatar_wrap" style="background: url(' + data[ih]['avatar'] + ') top left no-repeat; margin: 0 auto; height: 45px; width: 45px; background-size: cover;"></div>';
                    events_history_html += '</div>';
                    events_history_html += '<div class="col-md-9 col-sm-9 col-xs-9">';
                    events_history_html += '<a target="_blank" href="/user?userid=' + data[ih]['userid'] + '">' + data[ih]['fio'] + '</a>';
                    events_history_html += ' <span style="color: grey; font-size: 12px;">' + data[ih]['edate'] + ' в ' + data[ih]['etime'] + '</span><br/>';
                    events_history_html += act_text;
                    events_history_html += '</div>';
                    events_history_html += '<div class="col-md-1 col-sm-1 col-xs-1 text-center user_event_history_item_ico">';
                    events_history_html += '<a ' + act_mark_js + ' target="_blank" href="' + act_href + '" style="border: 0;"><span style="font-size: 20px; display: block; color: ' + act_ico_color + ';" class="glyphicon glyphicon-' + act_ico + '"></span></a>';
                    events_history_html += '</div>';
                    events_history_html += '<div class="clearer"></div></div>';

                    ih++;
                });

                var events_not_shown_now = parseInt(data[0]['total_unshowed']) - event_items_show_count;

                if (events_not_shown_now <= 0) {
                    $('#events_history_counter').fadeOut(300, function() {
                        $(this).html(0);
                    });
                    $('.user_events_notification_mark_all').fadeOut(150, function() {
                        if (typeof isMobile !== 'undefined' && typeof userEventsHistoryWraperResize !== 'undefined') {
                            if (isMobile) userEventsHistoryWraperResize();
                        }
                    });
                } else {
                    $('#events_history_counter').html(events_not_shown_now);
                    $('.user_events_notification_mark_all').fadeIn(150, function() {
                        if (typeof isMobile !== 'undefined' && typeof userEventsHistoryWraperResize !== 'undefined') {
                            if (isMobile) userEventsHistoryWraperResize();
                        }
                    });
                }

            } else {
                if (events_history_offset == 0) {
                    events_history_html = '<div class="col-md-12 text-center user_event_history_item user_event_history_no_data">У вас пока нет уведомлений</div>';
                }
            }
			
            if (ih == events_history_limit) {
                events_history_offset += events_history_limit;
                events_history_load_next = true;
            } else {
                events_history_load_next = false;
            }
			
            $(nc).append(events_history_html);
            $('#user_events_history_preloader').remove();
			
        }, 'json').fail(function(xhr, textStatus, thrownError, data) {
            $('#user_events_history_preloader').remove();
            $(nc).append('<div>' + translateXHRError(xhr, textStatus) + ' <a href="javascript:void(0)" onclick="events_history_load_next = true; getUserEventsHistory();">Повторить</a></div>');
            $(nc).find('>div').last().addClass('user_event_history_item user_event_history_loading_error');
        });
    } else {
        events_history_load_scroll = false;
        aObj.fadeOut(300, function() {
            $(nc).html('');
        });
        events_history_offset = 0;
        events_history_load_next = true;
    }
}

function markUserEventsHistory() {

    $('.user_events_notification_mark_loading').show();
    $('.user_events_notification_mark_all').fadeOut(150, function() {
        if (typeof isMobile !== 'undefined' && typeof userEventsHistoryWraperResize !== 'undefined') {
            if (isMobile) userEventsHistoryWraperResize();
        }
    });

    $.post('/user_events_notificaton_history_content_load', {
        'mark_all': 1
    }, function(data) {

        $('.user_events_notification_mark_loading').hide();

        if (data.success) {
            $('#events_history_counter').fadeOut(300, function() {
                $(this).html(0);
            });
            $('#user_events_notificaton_history_content_loaded_data .user_event_history_item').removeClass('not-shown');
        }

    }, 'json').fail(function(xhr, textStatus, thrownError, data) {
        $('.user_events_notification_mark_loading').hide();
        $('.user_events_notification_mark_all').fadeIn(150, function() {
            if (typeof isMobile !== 'undefined' && typeof userEventsHistoryWraperResize !== 'undefined') {
                if (isMobile) userEventsHistoryWraperResize();
            }
        });
        alert(translateXHRError(xhr, textStatus));
    });
}

function translateXHRError(xhr, exception) {

    var message;

     var statusErrorMap = {
        '0': "Обрыв при выполнении запроса. Проверьте соединение с интернетом.",
        '400': "Некорректный запрос.",
        '401': "Неавторизованный доступ.",
        '403': "Доступ запрещен.",
        '404': "Не найден обработчик запроса. Вероятно, ваша сессия устарела. Обновите страницу и повторите запрос.",
        '500': "Внутренняя ошибка сервера.",
        '503': "Сервис недоступен."
    };

    if (exception == 'parsererror') {
        message = "Ошибка обработки данных. Обновите страницу и повторите запрос.";
    } else if (exception == 'timeout') {
        message = "Истекло время ожидания.";
    } else if (exception == 'abort') {
        message = "Запрос был отклонен.";
    } else if (statusErrorMap[xhr.status]) {
        message = statusErrorMap[xhr.status];
    } else {
        message = "Неизвестная ошибка.";
    }

    return message;
}

try {

    function alert(msg) {
        var alert_container = document.createElement('div');
        $('html, body').css('overflow', 'hidden');
        $(alert_container).attr('class', 'alert-override-container').append('<div class="alert-override-wrp">' + msg + '<span class="glyphicon glyphicon-remove" onclick="$(this).closest(\'.alert-override-container\').remove();$(\'html, body\').css(\'overflow\', \'\')"></span></div>');
        $('body').append(alert_container);
    }

} catch (e) {
    console.log('Alert override: ' + e);
}

function showModalImg(src) {
    if (!src) {
        $('#img_modal').hide();
        $('#img_modal').html('');
        $('body').css('overflow', '');
    } else {
        $('#img_modal').show();
        $('#img_modal').append('<img src="' + src + '" />');
        $('#img_modal').append('<div id="img_modal-control-wrp">' +
            '<span class="glyphicon glyphicon-repeat rotate-left" aria-hidden="true"></span>' +
            '<span class="glyphicon glyphicon-repeat rotate-right" aria-hidden="true"></span>' +
            '<span class="glyphicon glyphicon-zoom-in" aria-hidden="true"></span>' +
            '<span class="glyphicon glyphicon-zoom-out" aria-hidden="true"></span>' +
            '<span class="glyphicon glyphicon-remove" aria-hidden="true"></span>' +
            '</div>');

        var img = $('#img_modal img'),
            rotate_degr = 0,
            img_height = parseInt(img.css('height')),
            mouse_down = false,
            offset = [];

        img.on('mousedown touchstart', function(e) {
            e.preventDefault();
            e.stopPropagation();
            $('#img_modal').removeAttr('onclick');
            mouse_down = true;
            offset = [
                this.offsetLeft - (e.changedTouches ? e.changedTouches[0].clientX : e.clientX),
                this.offsetTop - (e.changedTouches ? e.changedTouches[0].clientY : e.clientY)
            ];
        });

        img.on('mouseup touchend', function(e) {
            mouse_down = false;
            setTimeout(
                function() {
                    $('#img_modal').attr('onclick', 'showModalImg(null)');
                }
                , 50
            );
        });

        img.on('mousemove touchmove', function(e) {
            e.preventDefault();
            if (mouse_down) {
                $(this).css({
                    'left': ((e.changedTouches ? e.changedTouches[0].clientX : e.clientX) + offset[0]) + 'px',
                    'top': ((e.changedTouches ? e.changedTouches[0].clientY : e.clientY) + offset[1]) + 'px'
                });
            }
        });

        $('#img_modal .glyphicon').on('click', function(e) {

            e.stopPropagation();

            if ($(this).hasClass('rotate-right')) {
                rotate_degr += 90;
            }
			
            if ($(this).hasClass('rotate-left')) {
                rotate_degr -= 90;
            }

            if ($(this).hasClass('glyphicon-zoom-in') && img_height < 2000) {
                img_height += 200;
            }

            if ($(this).hasClass('glyphicon-zoom-out') && img_height > 300) {
                img_height -= 200;
            }
			
            if ($(this).hasClass('glyphicon-remove')) {
                showModalImg(null);
            }

            img.css({
                'transform': 'rotate(' + rotate_degr + 'deg)',
                'height': img_height + 'px'
            });
        });
		
        $('body').css('overflow', 'hidden');
    }
}

$(document).ready(function() {
	
    initCustomScroll();
	
    if ($('#user_events_notificaton_history_content_loaded_data').length) {
        $('#user_events_notificaton_history_content_loaded_data').scroll(function() {
            var currentEventsScroll = $('#user_events_notificaton_history_content_loaded_data').scrollTop(),
                h_events_height = $('#user_events_notificaton_history_content_loaded_data')[0].scrollHeight - $('#user_events_notificaton_history_content_loaded_data').outerHeight();
            if (currentEventsScroll > h_events_height - 1500 && events_history_load_scroll) {
                getUserEventsHistory();
            }
        });
    }
	
    $(this).delegate('.post_wrap_single img', 'click', function(e) {
        e.preventDefault();
        showModalImg($(this).attr('src'));
    });
});

$(document).on('mousedown', function(e) {

    if ($('#user_events_notificaton_history_content_loaded_data').length) {

        if (
            !$(e.target).closest('.user_events_notificaton_history').length &&
            !$(e.target).closest('.user_event_history_item').length
        ) {
            $('#user_events_notificaton_history_wraper').fadeOut(300, function() {
                $('#user_events_notificaton_history_content_loaded_data').html('');
            });
            events_history_offset = 0;
            events_history_load_next = true;
            events_history_load_scroll = false;
        }

    }
});